# lab2实验报告
## 实现功能

给之前的获取时间与获取任务信息的系统调用增加分页模式下的支持，主要是通过写了一个可以在内核态向某个用户的地址空间的虚拟地址上的裸指针位置写入数据的函数，
来把时间和任务信息正确放在用户地址空间的虚拟地址上。之后写了mmap和munmap两个新的系统调用，mmap通过查询地址空间的页表来确定是否可以分配这片内存
（有没有已经分出去的部分），munmap通过遍历地址空间的逻辑段只对起始结束位置匹配的逻辑段进行释放。

## 简答作业
1. 请列举 SV39 页表页表项的组成，描述其中的标志位有何作用？  

    __答：__    

      1. 0到7位为V、R、W、X、U、G、A、D标志位

          * V：页表项指向的页表是否有效
          * R：页表项指向的页表是否可读
          * W：页表项指向的页表是否可写
          * X：页表项指向的页表是否可执行
          * U：页表项是否可被用户级访问
          * G：Global标志位，转换适用于所有地址空间
          * A：处理器记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被访问过
          * D：处理器记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被修改过

      2. 8到9位是RSW，为S级软件保留
      3. 10到53位是指向的页表所在的物理页帧号
      4. 53到63是保留位
        
2. 缺页

    缺页指的是进程访问页面时页面不在页表中或在页表中无效的现象，此时 MMU 将会返回一个中断， 告知 os 进程内存访问出了问题。os 选择填补页表并重新执行异常指令或者杀死进程。
    
    1. 请问哪些异常可能是缺页导致的？
    
        __答：__ 使用munmap释放空间时存在未被映射的内存而报错。访问某个地址出现缺页的访存错误。
        
    2. 发生缺页时，描述相关重要寄存器的值，上次实验描述过的可以简略。
    
        __答：__ 上次实验描述过，略。
                    
    缺页有两个常见的原因，其一是 Lazy 策略，也就是直到内存页面被访问才实际进行页表操作。 比如，一个程序被执行时，进程的代码段理论上需要从磁盘加载到内存。但是 os 并不会马上这样做， 而是会保存 .text 段在磁盘的位置信息，在这些代码第一次被执行时才完成从磁盘的加载操作。
    
      __答：__ 确保内存资源在时间上有效利用。
        
    其实，我们的 mmap 也可以采取 Lazy 策略，比如：一个用户进程先后申请了 10G 的内存空间， 然后用了其中 1M 就直接退出了。按照现在的做法，我们显然亏大了，进行了很多没有意义的页表操作。  
    
    1. 处理 10G 连续的内存页面，对应的 SV39 页表大致占用多少内存 (估算数量级即可)？
    
        __答：__ 20多MiB。每页4KiB，则10GiB需要2500000页，每页一级页表的页表项占8Bytes，一级页表共占20MiB，二级页表会少几个数量级，所以大概是20多MiB。
        
    2. 请简单思考如何才能实现 Lazy 策略，缺页时又如何处理？
    
        __答：__ 修改map函数，只进行记录页在磁盘上的位置信息等。当实际访存时进行载入。
        
    缺页的另一个常见原因是 swap 策略，也就是内存页面可能被换到磁盘上了，导致对应页面失效。
    
    1. 此时页面失效如何表现在页表项(PTE)上？
    
        __答：__ 页表项的存在位为“0”
        
3. 双页表与单页表

    为了防范侧信道攻击，我们的 os 使用了双页表。但是传统的设计一直是单页表的，也就是说， 用户线程和对应的内核线程共用同一张页表，只不过内核对应的地址只允许在内核态访问。
    
    1. 在单页表情况下，如何更换页表？
    
        __答：__ Trap时不进行更换，切换任务时进行更换。
        
    2. 单页表情况下，如何控制用户态无法访问内核页面？
    
        __答：__ 设置控制位U为0.
        
    3. 单页表有何优势？
    
        __答：__ 减少换表时间，Trap不必刷新快表，加速Trap时间。
        
    4. 双页表实现下，何时需要更换页表？假设你写一个单页表操作系统，你会选择何时更换页表
    
        __答：__ 双页表每到特权级切换时都会换表。单页表仅在切换任务时换表。
